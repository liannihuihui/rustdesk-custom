name: Build Custom RustDesk Client

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # 允许手动触发构建

env:
  RUST_VERSION: "1.75"
  FLUTTER_VERSION: "3.24.5"
  CARGO_TERM_COLOR: always
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-msvc

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
          key: ${{ runner.os }}-vcpkg-${{ env.VCPKG_COMMIT_ID }}-${{ hashFiles('**/vcpkg.json') }}

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          git checkout ${{ env.VCPKG_COMMIT_ID }}
          .\bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "VCPKG_INSTALLATION_ROOT=C:\vcpkg" >> $env:GITHUB_ENV

      - name: Install dependencies
        run: |
          cd ${{ github.workspace }}
          C:\vcpkg\vcpkg install --triplet x64-windows-static --x-install-root=C:\vcpkg\installed

      - name: Build RustDesk
        run: |
          python build.py --flutter --hwcodec

      - name: Create installer
        run: |
          iscc /O"output" "res\installer.iss"
        continue-on-error: true

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-custom
          path: |
            target/release/rustdesk.exe
            output/rustdesk-setup.exe
          retention-days: 30

  build-linux:
    name: Build for Linux
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-unknown-linux-gnu

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl \
            wget \
            gcc \
            git \
            cmake \
            libclang-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgtk-3-dev \
            libxcb-randr0-dev \
            libxdo-dev \
            libxfixes-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libasound2-dev \
            libpulse-dev \
            libgstreamer-plugins-base1.0-dev \
            libpam0g-dev \
            libayatana-appindicator3-dev

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            /opt/artifacts/vcpkg/installed
          key: ${{ runner.os }}-vcpkg-${{ env.VCPKG_COMMIT_ID }}-${{ hashFiles('**/vcpkg.json') }}

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git /opt/artifacts/vcpkg
          cd /opt/artifacts/vcpkg
          git checkout ${{ env.VCPKG_COMMIT_ID }}
          ./bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=/opt/artifacts/vcpkg" >> $GITHUB_ENV

      - name: Install vcpkg dependencies
        run: |
          cd ${{ github.workspace }}
          /opt/artifacts/vcpkg/vcpkg install --x-install-root=/opt/artifacts/vcpkg/installed

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Build RustDesk
        run: |
          python3 build.py --flutter --hwcodec
        env:
          VCPKG_ROOT: /opt/artifacts/vcpkg

      - name: Create DEB package
        run: |
          mkdir -p package/DEBIAN package/usr/bin package/usr/share/applications
          cp target/release/rustdesk package/usr/bin/

          # Create control file
          cat > package/DEBIAN/control <<EOF
          Package: rustdesk-custom
          Version: 1.0.0
          Architecture: amd64
          Maintainer: Custom Build
          Description: RustDesk Custom Client
           Remote desktop software with custom configuration
          EOF

          dpkg-deb --build package rustdesk-x86_64.deb
        continue-on-error: true

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-linux-custom
          path: |
            target/release/rustdesk
            rustdesk-x86_64.deb
          retention-days: 30

  create-release:
    name: Create Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: rustdesk-windows-custom
          path: ./windows

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: rustdesk-linux-custom
          path: ./linux

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Custom Build ${{ github.run_number }}
          draft: false
          prerelease: false
          files: |
            windows/*
            linux/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
